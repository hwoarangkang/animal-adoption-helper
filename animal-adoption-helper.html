<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹•ç‰©èªé ˜é¤Šå°å¹«æ‰‹</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¶</text></svg>">
    
    <style>
        body {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            background-color: #f5f7fa;
            color: #333;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.2rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        /* ç¯©é¸å€å¡Šæ¨£å¼ */
        .filter-group {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            background: #fff;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            justify-content: center;
            align-items: center;
        }
        select, button {
            padding: 12px 16px;
            border: 1px solid #e1e4e8;
            border-radius: 10px;
            font-size: 15px;
            min-width: 130px;
            background-color: white;
            transition: all 0.3s ease;
        }
        select:focus {
            border-color: #4CAF50;
            outline: none;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }
        /* æŒ‰éˆ•ç‰¹è£½æ¨£å¼ */
        button.sort-btn {
            background: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        button.sort-btn:hover {
            background: #43a047;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);
        }
        button.sort-btn.active {
            background: #2e7d32;
        }

        /* å¡ç‰‡ç¶²æ ¼ */
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }
        .animal-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            border: 1px solid transparent;
        }
        .animal-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.1);
            border-color: #4CAF50;
        }
        .animal-img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background-color: #f0f0f0;
        }
        .animal-info {
            padding: 15px;
        }
        .tag-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        .tag {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        .tag.dog { background: #fff3e0; color: #ef6c00; }
        .tag.cat { background: #f3e5f5; color: #8e24aa; }
        .tag.male { background: #e3f2fd; color: #1976d2; }
        .tag.female { background: #fce4ec; color: #c2185b; }
        
        .shelter-name {
            font-size: 15px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .days-count {
            color: #d32f2f;
            font-weight: bold;
            font-size: 13px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* å½ˆå‡ºè¦–çª— (Modal) */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background: white;
            width: 90%;
            max-width: 600px;
            border-radius: 20px;
            padding: 25px;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: #f5f5f5;
        }
        .close-btn:hover { background: #e0e0e0; }

        .modal-body {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .modal-img {
            width: 100%;
            max-height: 350px;
            object-fit: contain;
            border-radius: 12px;
            background: #f0f0f0;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
        }
        .info-item {
            font-size: 14px;
        }
        .info-label { color: #666; font-size: 12px; margin-bottom: 2px; }
        .info-value { font-weight: bold; color: #333; }

        .action-btn {
            background: #1877F2;
            color: white;
            text-align: center;
            padding: 15px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            border: none;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .action-btn:hover { background: #166fe5; }

        /* åˆ†é  */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 40px;
            padding-bottom: 40px;
        }
        .pagination button {
            min-width: 40px;
            background: white;
            color: #333;
        }
        .pagination button.active {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        /* è®€å–å‹•ç•« */
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            flex-direction: column;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        @media (max-width: 600px) {
            .filter-group { flex-direction: column; }
            select, button { width: 100%; }
        }
    </style>
</head>
<body>
    <h1>ğŸ¶ å‹•ç‰©èªé ˜é¤Šå°å¹«æ‰‹</h1>
    
    <div class="filter-group">
        <select id="areaSelect" onchange="applyFilters()">
            <option value="">ğŸ  å…¨éƒ¨åœ°å€</option>
            <option value="2">è‡ºåŒ—å¸‚</option>
            <option value="3">æ–°åŒ—å¸‚</option>
            <option value="4">åŸºéš†å¸‚</option>
            <option value="5">å®œè˜­ç¸£</option>
            <option value="6">æ¡ƒåœ’å¸‚</option>
            <option value="7">æ–°ç«¹ç¸£</option>
            <option value="8">æ–°ç«¹å¸‚</option>
            <option value="9">è‹—æ —ç¸£</option>
            <option value="10">è‡ºä¸­å¸‚</option>
            <option value="11">å½°åŒ–ç¸£</option>
            <option value="12">å—æŠ•ç¸£</option>
            <option value="13">é›²æ—ç¸£</option>
            <option value="14">å˜‰ç¾©ç¸£</option>
            <option value="15">å˜‰ç¾©å¸‚</option>
            <option value="16">è‡ºå—å¸‚</option>
            <option value="17">é«˜é›„å¸‚</option>
            <option value="18">å±æ±ç¸£</option>
            <option value="19">èŠ±è“®ç¸£</option>
            <option value="20">è‡ºæ±ç¸£</option>
            <option value="21">æ¾æ¹–ç¸£</option>
            <option value="22">é‡‘é–€ç¸£</option>
            <option value="23">é€£æ±Ÿç¸£</option>
        </select>

        <select id="typeSelect" onchange="applyFilters()">
            <option value="">ğŸ¾ å…¨éƒ¨é¡å‹</option>
            <option value="ç‹—">ç‹—ç‹—</option>
            <option value="è²“">è²“å’ª</option>
        </select>

        <select id="colorSelect" onchange="applyFilters()">
            <option value="">ğŸ¨ å…¨éƒ¨é¡è‰²</option>
            <option value="é»‘è‰²">é»‘è‰²</option>
            <option value="ç™½è‰²">ç™½è‰²</option>
            <option value="è™æ–‘">è™æ–‘</option>
            <option value="æ£•è‰²">æ£•è‰²</option>
            <option value="ç°è‰²">ç°è‰²</option>
            <option value="é»ƒè‰²">é»ƒè‰²</option>
            <option value="èŠ±è‰²">èŠ±è‰²</option>
        </select>

        <select id="genderSelect" onchange="applyFilters()">
            <option value="">âš§ï¸ å…¨éƒ¨æ€§åˆ¥</option>
            <option value="M">ç”·ç”Ÿ</option>
            <option value="F">å¥³ç”Ÿ</option>
        </select>

        <button id="sortBtn" class="sort-btn" onclick="toggleSort()">
            â³ æ’åºï¼šå…¥æ‰€æ™‚é–“ (æœ€ä¹…å…ˆ)
        </button>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div style="font-weight:bold; color:#555;">æ­£åœ¨æœå°‹ç­‰å¾…å®¶çš„æ¯›å­©...</div>
    </div>

    <div class="gallery" id="gallery"></div>
    <div class="pagination" id="pagination"></div>

    <div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
        <div class="modal-content">
            <div class="close-btn" onclick="closeModal('force')">Ã—</div>
            <div class="modal-body" id="modalBody">
                </div>
        </div>
    </div>

    <script>
        let rawData = [];
        let displayData = [];
        let currentPage = 1;
        const itemsPerPage = 24;
        let isSortAscending = true; // true = èˆŠåˆ°æ–° (æœ€ä¹…å…ˆ), false = æ–°åˆ°èˆŠ

        // å•Ÿå‹•ï¼šæŠ“å–è³‡æ–™
        async function fetchAllData() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.display = 'flex';
            
            try {
                // æŠ“å– 2000 ç­†è³‡æ–™
                const apiUrl = `https://data.moa.gov.tw/Service/OpenData/TransService.aspx?UnitId=QcbUEzN6E6DL&$filter=animal_status eq 'OPEN'&$top=2000`;
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error('API Error');
                
                rawData = await response.json();
                applyFilters(); // åˆå§‹ç¯©é¸
                
            } catch (error) {
                console.error(error);
                document.getElementById('gallery').innerHTML = '<div style="text-align:center; grid-column:1/-1; padding:30px;">âš ï¸ ç„¡æ³•é€£ç·šè‡³è³‡æ–™åº«ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</div>';
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        // ç¯©é¸é‚è¼¯
        function applyFilters() {
            const area = document.getElementById('areaSelect').value;
            const type = document.getElementById('typeSelect').value;
            const color = document.getElementById('colorSelect').value;
            const gender = document.getElementById('genderSelect').value;

            displayData = rawData.filter(animal => {
                if (area && animal.animal_area_pkid != area) return false;
                if (type && animal.animal_kind !== type) return false;
                if (color && animal.animal_colour !== color) return false;
                if (gender && animal.animal_sex !== gender) return false;
                return true;
            });

            executeSort(); // ç¯©é¸å¾ŒåŸ·è¡Œæ’åº
        }

        // åˆ‡æ›æ’åºæ¨¡å¼
        function toggleSort() {
            isSortAscending = !isSortAscending;
            const btn = document.getElementById('sortBtn');
            if (isSortAscending) {
                btn.innerHTML = 'â³ æ’åºï¼šå…¥æ‰€æ™‚é–“ (æœ€ä¹…å…ˆ)';
                btn.classList.add('active');
            } else {
                btn.innerHTML = 'ğŸ†• æ’åºï¼šå…¥æ‰€æ™‚é–“ (æœ€æ–°å…ˆ)';
                btn.classList.remove('active');
            }
            executeSort();
        }

        // åŸ·è¡Œæ’åº
        function executeSort() {
            displayData.sort((a, b) => {
                const dateA = new Date(a.animal_createtime);
                const dateB = new Date(b.animal_createtime);
                return isSortAscending ? dateA - dateB : dateB - dateA;
            });
            currentPage = 1;
            renderGallery();
            renderPagination();
        }

        // è¨ˆç®—å¤©æ•¸
        function calculateDays(dateString) {
            const start = new Date(dateString);
            const now = new Date();
            const diff = now - start;
            return Math.floor(diff / (1000 * 60 * 60 * 24));
        }

        // æ¸²æŸ“å¡ç‰‡
        function renderGallery() {
            const gallery = document.getElementById('gallery');
            if (displayData.length === 0) {
                gallery.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #888; font-size: 18px;">ğŸ• æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„æ¯›å°å­©ï¼Œè©¦è©¦çœ‹æ”¾å¯¬æ¢ä»¶å§ï¼</div>';
                return;
            }

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const animalsToShow = displayData.slice(start, end);

            gallery.innerHTML = animalsToShow.map((animal, index) => {
                let imgUrl = animal.album_file || '';
                if (imgUrl.startsWith('http:')) imgUrl = imgUrl.replace('http:', 'https:');
                if (!imgUrl) imgUrl = 'https://via.placeholder.com/300x220?text=ç„¡ç…§ç‰‡';

                const days = calculateDays(animal.animal_createtime);
                const genderTag = animal.animal_sex === 'M' ? '<span class="tag male">â™‚ ç”·ç”Ÿ</span>' : (animal.animal_sex === 'F' ? '<span class="tag female">â™€ å¥³ç”Ÿ</span>' : '');
                const typeTag = animal.animal_kind === 'ç‹—' ? '<span class="tag dog">ğŸ¶ ç‹—ç‹—</span>' : '<span class="tag cat">ğŸ± è²“å’ª</span>';

                // å°‡è³‡æ–™å­˜å…¥ dataset æ–¹ä¾¿ Modal è®€å–ï¼Œé¿å…å‚³éè¤‡é›œåƒæ•¸
                // æ³¨æ„ï¼šé€™è£¡ä½¿ç”¨ data-index ä¾†å°æ‡‰ç•¶å‰é é¢çš„é™£åˆ—
                return `
                <div class="animal-card" onclick="openModal(${start + index})">
                    <img src="${imgUrl}" class="animal-img" loading="lazy" alt="animal">
                    <div class="animal-info">
                        <div class="tag-row">${typeTag} ${genderTag}</div>
                        <div class="shelter-name">${animal.animal_place || animal.shelter_name}</div>
                        <div style="font-size:13px; color:#666;">${animal.animal_Variety} / ${animal.animal_colour}</div>
                        <div class="days-count">ğŸ•’ å·²ç­‰å¾… ${days} å¤©</div>
                    </div>
                </div>
            `}).join('');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // åˆ†é æ¸²æŸ“
        function renderPagination() {
            const totalPages = Math.ceil(displayData.length / itemsPerPage);
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            if (totalPages <= 1) return;

            const maxButtons = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
            let endPage = Math.min(totalPages, startPage + maxButtons - 1);

            if (endPage - startPage + 1 < maxButtons) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }

            // ä¸Šä¸€é 
            const prevButton = document.createElement('button');
            prevButton.textContent = 'Â«';
            prevButton.disabled = currentPage === 1;
            prevButton.onclick = () => { if(currentPage > 1) { currentPage--; renderGallery(); renderPagination(); } };
            pagination.appendChild(prevButton);

            // é ç¢¼
            for (let i = startPage; i <= endPage; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.className = i === currentPage ? 'active' : '';
                button.onclick = () => { currentPage = i; renderGallery(); renderPagination(); };
                pagination.appendChild(button);
            }

            // ä¸‹ä¸€é 
            const nextButton = document.createElement('button');
            nextButton.textContent = 'Â»';
            nextButton.disabled = currentPage === totalPages;
            nextButton.onclick = () => { if(currentPage < totalPages) { currentPage++; renderGallery(); renderPagination(); } };
            pagination.appendChild(nextButton);
        }

        // --- å½ˆå‡ºè¦–çª—ç›¸é—œåŠŸèƒ½ ---

        function openModal(index) {
            const animal = displayData[index];
            if (!animal) return;

            const days = calculateDays(animal.animal_createtime);
            let imgUrl = animal.album_file || '';
            if (imgUrl.startsWith('http:')) imgUrl = imgUrl.replace('http:', 'https:');
            
            const modalBody = document.getElementById('modalBody');
            
            // æ§‹å»º FB è²¼æ–‡å…§å®¹
            const fbText = `ã€èªé¤Šæ–‡ã€‘æ±‚åˆ†äº« ğŸ \né€™éš»å¯æ„›çš„ ${animal.animal_Variety} å·²ç¶“åœ¨ ${animal.shelter_name} ç­‰å®¶ ${days} å¤©äº†ï¼\n\nğŸ¾ ç·¨è™Ÿï¼š${animal.animal_id}\nğŸ¾ æ€§åˆ¥ï¼š${animal.animal_sex === 'M' ? 'ç”·ç”Ÿ' : 'å¥³ç”Ÿ'}\nğŸ¾ æ¯›è‰²ï¼š${animal.animal_colour}\nğŸ¾ åœ°é»ï¼š${animal.shelter_address || animal.shelter_name}\nğŸ¾ é›»è©±ï¼š${animal.shelter_tel}\n\n#é ˜é¤Šä»£æ›¿è³¼è²· #å‹•ç‰©èªé¤Š`;

            modalBody.innerHTML = `
                <img src="${imgUrl || 'https://via.placeholder.com/400x300'}" class="modal-img">
                <div style="font-size: 1.2rem; font-weight: bold; margin: 5px 0;">${animal.animal_place || animal.shelter_name}</div>
                <div class="info-grid">
                    <div class="info-item"><div class="info-label">æ”¶å®¹ç·¨è™Ÿ</div><div class="info-value">${animal.animal_subid || animal.animal_id}</div></div>
                    <div class="info-item"><div class="info-label">å…¥æ‰€å¤©æ•¸</div><div class="info-value" style="color:#d32f2f">${days} å¤©</div></div>
                    <div class="info-item"><div class="info-label">å“ç¨®</div><div class="info-value">${animal.animal_Variety}</div></div>
                    <div class="info-item"><div class="info-label">æ€§åˆ¥</div><div class="info-value">${animal.animal_sex === 'M' ? 'ç”·ç”Ÿ' : 'å¥³ç”Ÿ'}</div></div>
                    <div class="info-item"><div class="info-label">æ¯›è‰²</div><div class="info-value">${animal.animal_colour}</div></div>
                    <div class="info-item"><div class="info-label">é«”å‹</div><div class="info-value">${animal.animal_bodytype === 'MINI' ? 'å°å‹' : (animal.animal_bodytype === 'MEDIUM' ? 'ä¸­å‹' : 'å¤§å‹')}</div></div>
                    <div class="info-item"><div class="info-label">è¯çµ¡é›»è©±</div><div class="info-value">${animal.shelter_tel}</div></div>
                    <div class="info-item" style="grid-column: 1/-1"><div class="info-label">åœ°å€</div><div class="info-value">${animal.shelter_address || 'è«‹æ´½æ”¶å®¹æ‰€'}</div></div>
                    ${animal.animal_remark ? `<div class="info-item" style="grid-column: 1/-1"><div class="info-label">å‚™è¨»</div><div class="info-value">${animal.animal_remark}</div></div>` : ''}
                </div>
                
                <button class="action-btn" onclick="copyToClipboard(\`${fbText.replace(/`/g, '\\`')}\`)">
                    ğŸ“‹ è¤‡è£½ FB è²¼æ–‡å…§å®¹ (å«ç…§ç‰‡é€£çµ)
                </button>
            `;

            document.getElementById('modalOverlay').style.display = 'flex';
            document.body.style.overflow = 'hidden'; // é˜²æ­¢èƒŒæ™¯æ»¾å‹•
        }

        function closeModal(event) {
            if (event === 'force' || event.target.id === 'modalOverlay') {
                document.getElementById('modalOverlay').style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('å…§å®¹å·²è¤‡è£½ï¼\nç¾åœ¨æ‚¨å¯ä»¥åˆ° Facebook è²¼ä¸Šç™¼æ–‡ä¸¦é™„ä¸Šç…§ç‰‡å›‰ï¼ğŸ¶');
            }).catch(err => {
                console.error('è¤‡è£½å¤±æ•—', err);
                alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚');
            });
        }

        // åˆå§‹åŒ–
        fetchAllData();
    </script>
</body>
</html>
