<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹•ç‰©èªé ˜é¤Šå°å¹«æ‰‹</title>
    <style>
        body {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            background-color: #f5f5f5;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .filter-group {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            justify-content: center;
        }
        select, button {
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
            min-width: 130px;
            background-color: white;
        }
        select:focus {
            border-color: #4CAF50;
            outline: none;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(76, 175, 80, 0.3);
        }
        button:hover {
            background: #43a047;
            transform: translateY(-2px);
        }
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }
        .animal-card {
            border: none;
            border-radius: 12px;
            padding: 0;
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
            overflow: hidden;
            background: white;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            position: relative;
        }
        .animal-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }
        .animal-img {
            width: 100%;
            height: 220px;
            object-fit: cover;
            background-color: #eee;
            transition: opacity 0.3s;
        }
        .animal-info {
            padding: 18px;
            font-size: 14px;
            line-height: 1.6;
            color: #444;
        }
        .animal-info .tag-container {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        .animal-info .tag {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        .animal-info .tag.gender-m { background: #e3f2fd; color: #1565c0; }
        .animal-info .tag.gender-f { background: #fce4ec; color: #c2185b; }
        
        .shelter-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 6px;
            color: #222;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 40px;
            flex-wrap: wrap;
            padding-bottom: 40px;
        }
        .pagination button {
            min-width: 45px;
            padding: 8px 15px;
            background: white;
            color: #333;
            border: 1px solid #ddd;
            box-shadow: none;
        }
        .pagination button.active {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        .pagination button:hover:not(.active):not(:disabled) {
            background: #f1f1f1;
            transform: none;
        }
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        @media (max-width: 600px) {
            .filter-group { flex-direction: column; }
            select, button { width: 100%; }
        }
    </style>
</head>
<body>
    <h1>ğŸ¾ å‹•ç‰©èªé ˜é¤Šå°å¹«æ‰‹</h1>
    
    <div class="filter-group">
        <select id="areaSelect" onchange="applyFilters()">
            <option value="">ğŸ  å…¨éƒ¨åœ°å€</option>
            <option value="2">è‡ºåŒ—å¸‚</option>
            <option value="3">æ–°åŒ—å¸‚</option>
            <option value="4">åŸºéš†å¸‚</option>
            <option value="5">å®œè˜­ç¸£</option>
            <option value="6">æ¡ƒåœ’å¸‚</option>
            <option value="7">æ–°ç«¹ç¸£</option>
            <option value="8">æ–°ç«¹å¸‚</option>
            <option value="9">è‹—æ —ç¸£</option>
            <option value="10">è‡ºä¸­å¸‚</option>
            <option value="11">å½°åŒ–ç¸£</option>
            <option value="12">å—æŠ•ç¸£</option>
            <option value="13">é›²æ—ç¸£</option>
            <option value="14">å˜‰ç¾©ç¸£</option>
            <option value="15">å˜‰ç¾©å¸‚</option>
            <option value="16">è‡ºå—å¸‚</option>
            <option value="17">é«˜é›„å¸‚</option>
            <option value="18">å±æ±ç¸£</option>
            <option value="19">èŠ±è“®ç¸£</option>
            <option value="20">è‡ºæ±ç¸£</option>
            <option value="21">æ¾æ¹–ç¸£</option>
            <option value="22">é‡‘é–€ç¸£</option>
            <option value="23">é€£æ±Ÿç¸£</option>
        </select>

        <select id="typeSelect" onchange="applyFilters()">
            <option value="">ğŸ¶ å…¨éƒ¨é¡å‹</option>
            <option value="ç‹—">ç‹—ç‹—</option>
            <option value="è²“">è²“å’ª</option>
        </select>

        <select id="colorSelect" onchange="applyFilters()">
            <option value="">ğŸ¨ å…¨éƒ¨é¡è‰²</option>
            <option value="é»‘è‰²">é»‘è‰²</option>
            <option value="ç™½è‰²">ç™½è‰²</option>
            <option value="è™æ–‘">è™æ–‘</option>
            <option value="æ£•è‰²">æ£•è‰²</option>
            <option value="ç°è‰²">ç°è‰²</option>
            <option value="é»ƒè‰²">é»ƒè‰²</option>
            <option value="èŠ±è‰²">èŠ±è‰²</option>
        </select>

        <select id="genderSelect" onchange="applyFilters()">
            <option value="">âš§ï¸ å…¨éƒ¨æ€§åˆ¥</option>
            <option value="M">ç”·ç”Ÿ</option>
            <option value="F">å¥³ç”Ÿ</option>
        </select>

        <button onclick="sortOldest()">â³ ç¯©é¸å…¥æ‰€æœ€ä¹…</button>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div id="loadingText">æ­£åœ¨å°‹æ‰¾æ¯›å°å­©...</div>
    </div>

    <div class="gallery" id="gallery"></div>
    <div class="pagination" id="pagination"></div>

    <script>
        let rawData = [];      // å­˜æ”¾å¾ API æŠ“å›ä¾†çš„åŸå§‹è³‡æ–™
        let displayData = [];  // å­˜æ”¾ç¶“éç¯©é¸å¾Œè¦é¡¯ç¤ºçš„è³‡æ–™
        let currentPage = 1;
        const itemsPerPage = 24;

        // åˆå§‹åŒ–ï¼šä¸€é€²ä¾†å°±æŠ“å–å¤§é‡è³‡æ–™
        async function fetchAllData() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.display = 'flex';
            
            try {
                // ç­–ç•¥ï¼šä¸€æ¬¡æŠ“å– 2000 ç­† "é–‹æ”¾èªé¤Š(OPEN)" çš„è³‡æ–™ï¼Œä¸åˆ†åœ°å€
                // é€™æ¨£æˆ‘å€‘å°±å¯ä»¥åœ¨æœ¬åœ°ç«¯è‡ªç”±ç¯©é¸ï¼Œä¸å— API é™åˆ¶
                const apiUrl = `https://data.moa.gov.tw/Service/OpenData/TransService.aspx?UnitId=QcbUEzN6E6DL&$filter=animal_status eq 'OPEN'&$top=2000`;
                
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error('ç¶²è·¯å›æ‡‰ç•°å¸¸');
                
                rawData = await response.json();
                
                // åˆå§‹é¡¯ç¤º
                applyFilters();
                
            } catch (error) {
                console.error('è³‡æ–™æŠ“å–å¤±æ•—:', error);
                document.getElementById('gallery').innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #666;">âš ï¸ è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦ã€‚<br>æ”¿åºœè³‡æ–™åº«å¯èƒ½æš«æ™‚ç„¡æ³•é€£ç·šã€‚</div>';
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        // æ ¸å¿ƒåŠŸèƒ½ï¼šæœ¬åœ°ç¯©é¸
        function applyFilters() {
            const area = document.getElementById('areaSelect').value;
            const type = document.getElementById('typeSelect').value;
            const color = document.getElementById('colorSelect').value;
            const gender = document.getElementById('genderSelect').value;

            // ä½¿ç”¨ JavaScript çš„ filter åŠŸèƒ½ï¼Œæ¯” API æ›´ç©©å®š
            displayData = rawData.filter(animal => {
                // åœ°å€ç¯©é¸ (æ³¨æ„ï¼šAPI å›å‚³çš„å¯èƒ½æ˜¯æ•¸å­—æˆ–å­—ä¸²ï¼Œé€™è£¡ç”¨ == æ¯”è¼ƒå®‰å…¨)
                if (area && animal.animal_area_pkid != area) return false;
                // é¡å‹ç¯©é¸
                if (type && animal.animal_kind !== type) return false;
                // é¡è‰²ç¯©é¸
                if (color && animal.animal_colour !== color) return false;
                // æ€§åˆ¥ç¯©é¸
                if (gender && animal.animal_sex !== gender) return false;
                
                return true;
            });

            currentPage = 1;
            renderGallery();
            renderPagination();
        }

        // æ’åºï¼šå…¥æ‰€æœ€ä¹…
        function sortOldest() {
            displayData.sort((a, b) => new Date(a.animal_createtime) - new Date(b.animal_createtime));
            currentPage = 1;
            renderGallery();
            renderPagination();
        }

        // æ¸²æŸ“ç•«é¢
        function renderGallery() {
            const gallery = document.getElementById('gallery');
            
            if (displayData.length === 0) {
                gallery.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #666; font-size: 18px;">ğŸ• æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„æ¯›å°å­©ï¼Œè©¦è©¦çœ‹æ”¾å¯¬æ¢ä»¶å§ï¼</div>';
                return;
            }

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const animalsToShow = displayData.slice(start, end);

            gallery.innerHTML = animalsToShow.map(animal => {
                // åœ–ç‰‡ç¶²å€è™•ç†
                let imgUrl = animal.album_file || '';
                if (imgUrl && imgUrl.startsWith('http:')) {
                    imgUrl = imgUrl.replace('http:', 'https:');
                }
                if (!imgUrl) imgUrl = 'https://via.placeholder.com/300x220?text=ç„¡ç…§ç‰‡';

                // æ€§åˆ¥é¡¯ç¤º
                const isMale = animal.animal_sex === 'M';
                const isFemale = animal.animal_sex === 'F';
                const sexText = isMale ? 'â™‚ ç”·ç”Ÿ' : (isFemale ? 'â™€ å¥³ç”Ÿ' : 'â“ æœªæ¨™ç¤º');
                const sexClass = isMale ? 'gender-m' : (isFemale ? 'gender-f' : '');

                // ä¿®æ­£é€£çµï¼šæ”¹ç‚ºå…¨åœ‹å‹•ç‰©æ”¶å®¹ç³»çµ±å…¬é–‹ç¶²å€
                const detailLink = `https://www.pet.gov.tw/Web/Detail.aspx?ID=${animal.animal_id}`;

                return `
                <div class="animal-card" onclick="window.open('${detailLink}', '_blank')">
                    <img src="${imgUrl}" class="animal-img" loading="lazy" alt="${animal.animal_Variety}" onerror="this.src='https://via.placeholder.com/300x220?text=åœ–ç‰‡å¤±æ•ˆ'">
                    <div class="animal-info">
                        <div class="tag-container">
                            <span class="tag">${animal.animal_kind}</span>
                            <span class="tag ${sexClass}">${sexText}</span>
                        </div>
                        <div class="shelter-name" title="${animal.animal_place || animal.shelter_name}">${animal.animal_place || animal.shelter_name}</div>
                        <div style="color: #666; font-size: 13px; margin-bottom: 4px;">å“ç¨®ï¼š${animal.animal_Variety} / ${animal.animal_colour}</div>
                        <div style="color: #999; font-size: 12px;">å…¥æ‰€æ—¥æœŸï¼š${animal.animal_createtime}</div>
                    </div>
                </div>
            `}).join('');
            
            // æ¯æ¬¡æ¸²æŸ“å¾Œæ»¾å‹•åˆ°é ‚éƒ¨
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // åˆ†é åŠŸèƒ½
        function renderPagination() {
            const totalPages = Math.ceil(displayData.length / itemsPerPage);
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            if (totalPages <= 1) return;

            const maxButtons = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
            let endPage = Math.min(totalPages, startPage + maxButtons - 1);

            if (endPage - startPage + 1 < maxButtons) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }

            // ä¸Šä¸€é 
            const prevButton = document.createElement('button');
            prevButton.textContent = 'Â«';
            prevButton.disabled = currentPage === 1;
            prevButton.onclick = () => { if(currentPage > 1) { currentPage--; renderGallery(); renderPagination(); } };
            pagination.appendChild(prevButton);

            // é ç¢¼
            for (let i = startPage; i <= endPage; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.className = i === currentPage ? 'active' : '';
                button.onclick = () => { currentPage = i; renderGallery(); renderPagination(); };
                pagination.appendChild(button);
            }

            // ä¸‹ä¸€é 
            const nextButton = document.createElement('button');
            nextButton.textContent = 'Â»';
            nextButton.disabled = currentPage === totalPages;
            nextButton.onclick = () => { if(currentPage < totalPages) { currentPage++; renderGallery(); renderPagination(); } };
            pagination.appendChild(nextButton);
        }

        // å•Ÿå‹•ç¨‹å¼
        fetchAllData();
    </script>
</body>
</html>
